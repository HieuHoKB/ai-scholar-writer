{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/Documents/hhkb/ai-scholar-writer/src/lib/brave-search.ts"],"sourcesContent":["// Brave Search API integration for finding academic sources and citations\n\nconst BRAVE_API_BASE = \"https://api.search.brave.com/res/v1\";\n\ninterface BraveSearchResponse {\n\tweb?: {\n\t\tresults: Array<{\n\t\t\ttitle: string;\n\t\t\turl: string;\n\t\t\tdescription: string;\n\t\t\tpublished_at?: string;\n\t\t\tauthor?: string;\n\t\t}>;\n\t};\n}\n\nexport interface SearchResult {\n\ttitle: string;\n\turl: string;\n\tsnippet: string;\n\tpublishedDate?: string;\n\tauthor?: string;\n}\n\nexport class BraveSearchService {\n\tprivate apiKey: string;\n\n\tconstructor(apiKey?: string) {\n\t\tthis.apiKey = apiKey || process.env.BRAVE_SEARCH_API_KEY || \"\";\n\t}\n\n\tasync searchAcademicLiterature(\n\t\tquery: string,\n\t\tcount: number = 5,\n\t): Promise<SearchResult[]> {\n\t\tif (!this.apiKey) {\n\t\t\tconsole.warn(\"Brave Search API key not configured\");\n\t\t\treturn [];\n\t\t}\n\n\t\ttry {\n\t\t\tconst response = await fetch(\n\t\t\t\t`${BRAVE_API_BASE}/search?q=${encodeURIComponent(\n\t\t\t\t\tquery,\n\t\t\t\t)}&count=${count}&engines=google,bing`,\n\t\t\t\t{\n\t\t\t\t\tmethod: \"GET\",\n\t\t\t\t\theaders: {\n\t\t\t\t\t\tAccept: \"application/json\",\n\t\t\t\t\t\t\"X-Subscription-Token\": this.apiKey,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tif (!response.ok) {\n\t\t\t\tconsole.error(`Brave Search API error: ${response.status}`);\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tconst data: BraveSearchResponse = await response.json();\n\n\t\t\treturn (data.web?.results || []).map((result) => ({\n\t\t\t\ttitle: result.title,\n\t\t\t\turl: result.url,\n\t\t\t\tsnippet: result.description,\n\t\t\t\tpublishedDate: result.published_at,\n\t\t\t\tauthor: result.author,\n\t\t\t}));\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Brave Search error:\", error);\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tasync searchForSection(\n\t\tsection: string,\n\t\ttopic: string,\n\t): Promise<SearchResult[]> {\n\t\tconst queries = this.buildSearchQueries(section, topic);\n\t\tconst results: SearchResult[] = [];\n\n\t\tfor (const query of queries) {\n\t\t\tconst searchResults = await this.searchAcademicLiterature(query, 3);\n\t\t\tresults.push(...searchResults);\n\t\t}\n\n\t\t// Remove duplicates\n\t\tconst uniqueResults = results.filter(\n\t\t\t(result, index, self) =>\n\t\t\t\tindex === self.findIndex((r) => r.url === result.url),\n\t\t);\n\n\t\treturn uniqueResults.slice(0, 10);\n\t}\n\n\tprivate buildSearchQueries(section: string, topic: string): string[] {\n\t\tconst baseQueries: Record<string, string[]> = {\n\t\t\tintroduction: [\n\t\t\t\t`${topic} research introduction background`,\n\t\t\t\t`${topic} research problem significance`,\n\t\t\t\t`${topic} research gap literature review`,\n\t\t\t],\n\t\t\tliterature: [\n\t\t\t\t`${topic} theoretical framework`,\n\t\t\t\t`${topic} prior research studies`,\n\t\t\t\t`${topic} literature review academic`,\n\t\t\t],\n\t\t\tmethods: [\n\t\t\t\t`${topic} research methodology`,\n\t\t\t\t`${topic} data collection analysis`,\n\t\t\t\t`${topic} research design sampling`,\n\t\t\t],\n\t\t\tresults: [\n\t\t\t\t`${topic} research findings statistics`,\n\t\t\t\t`${topic} empirical results data`,\n\t\t\t],\n\t\t\tdiscussion: [\n\t\t\t\t`${topic} research implications`,\n\t\t\t\t`${topic} study limitations future research`,\n\t\t\t\t`${topic} theoretical practical implications`,\n\t\t\t],\n\t\t\ttitle: [`${topic} research paper title academic`],\n\t\t\treferences: [`${topic} academic sources citations`],\n\t\t};\n\n\t\treturn baseQueries[section.toLowerCase()] || [`${topic} academic research`];\n\t}\n}\n\n// Helper function to create APA citation from search result\nexport function createAPACitation(result: SearchResult): string {\n\tconst author = result.author || \"Unknown\";\n\tconst year = result.publishedDate\n\t\t? new Date(result.publishedDate).getFullYear()\n\t\t: \"n.d.\";\n\tconst title = result.title;\n\tconst url = result.url;\n\n\treturn `${author}. (${year}). ${title}. ${url}`;\n}\n\n// Generate citation key for referencing\nexport function generateCitationKey(result: SearchResult): string {\n\tconst firstAuthor = result.author?.split(\" \")[0] || \"Unknown\";\n\tconst year = result.publishedDate\n\t\t? new Date(result.publishedDate).getFullYear()\n\t\t: \"nd\";\n\treturn `${firstAuthor}${year}`.toLowerCase().replace(/\\s+/g, \"\");\n}\n\n// Export singleton instance\nexport const braveSearch = new BraveSearchService();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 129, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/Documents/hhkb/ai-scholar-writer/src/app/api/generate/route.ts"],"sourcesContent":["import OpenAI from \"openai\";\nimport {\n\tbraveSearch,\n\tcreateAPACitation,\n\tgenerateCitationKey,\n\ttype SearchResult,\n} from \"@/lib/brave-search\";\n\n// Initialize OpenRouter client\nconst openrouter = new OpenAI({\n\tapiKey: process.env.OPENROUTER_API_KEY || \"\",\n\tbaseURL: \"https://openrouter.ai/api/v1\",\n});\n\nexport const runtime = \"edge\";\n\ninterface Citation {\n\tkey: string;\n\tformatted: string;\n\turl: string;\n}\n\ninterface GenerationResponse {\n\tcontent: string;\n\tsources: SearchResult[];\n\tcitations: Citation[];\n}\n\nasync function searchForRelevantSources(\n\tsection: string,\n\ttopic: string,\n): Promise<SearchResult[]> {\n\ttry {\n\t\tconst results = await braveSearch.searchForSection(section, topic);\n\t\treturn results;\n\t} catch (error) {\n\t\tconsole.error(\"Search error:\", error);\n\t\treturn [];\n\t}\n}\n\nasync function generateWithSources(\n\tprompt: string,\n\tsystemMessage: string,\n\tsources: SearchResult[],\n): Promise<string> {\n\t// Build enhanced system message with sources\n\tconst sourcesContext =\n\t\tsources.length > 0\n\t\t\t? `\\n\\nRelevant sources to cite:\\n${sources\n\t\t\t\t\t.map((source, index) => `[${index + 1}] ${createAPACitation(source)}`)\n\t\t\t\t\t.join(\"\\n\")}`\n\t\t\t: \"\";\n\n\tconst enhancedSystemMessage = `${systemMessage}${sourcesContext}\n\nIMPORTANT: When discussing concepts from these sources, include inline citations in APA format like (Author, Year) or (Author1 & Author2, Year).\nInclude the citation key in brackets like [1], [2] that references the sources list.\nProvide a comprehensive response that synthesizes information from these sources.`;\n\n\tconst completion = await openrouter.chat.completions.create({\n\t\tmodel: \"openai/gpt-oss-120b:free\",\n\t\tmessages: [\n\t\t\t{ role: \"system\", content: enhancedSystemMessage },\n\t\t\t{ role: \"user\", content: prompt },\n\t\t],\n\t\ttemperature: 0.7,\n\t\tmax_tokens: 2000,\n\t\tstream: false,\n\t});\n\n\treturn completion.choices[0]?.message?.content || \"\";\n}\n\nexport async function POST(req: Request): Promise<Response> {\n\ttry {\n\t\tconst { prompt, section, context, model } = await req.json();\n\n\t\tconsole.log(\"Generation request:\", { model, section });\n\t\tconsole.log(\n\t\t\t\"OpenRouter API key present:\",\n\t\t\t!!process.env.OPENROUTER_API_KEY,\n\t\t);\n\t\tconsole.log(\n\t\t\t\"Brave Search API key present:\",\n\t\t\t!!process.env.BRAVE_SEARCH_API_KEY,\n\t\t);\n\n\t\t// Build system message for academic writing\n\t\tconst systemMessage = `You are an academic writing assistant helping users write research papers.\n    You write in formal academic English following APA 7th edition style.\n    ${context ? `Context from previous sections: ${context}` : \"\"}\n    \n    Write high-quality academic content for the ${section} section.\n    Focus on clarity, precision, and scholarly tone.\n    Use appropriate academic vocabulary and sentence structures.`;\n\n\t\t// Search for relevant sources\n\t\tconsole.log(\"Searching for sources...\");\n\t\tconst sources = await searchForRelevantSources(section, prompt);\n\t\tconsole.log(\"Found sources:\", sources.length);\n\n\t\t// Generate content with citations\n\t\tconsole.log(\"Generating content with OpenRouter...\");\n\t\tconst content = await generateWithSources(prompt, systemMessage, sources);\n\t\tconsole.log(\"Generated content length:\", content.length);\n\n\t\t// Format citations\n\t\tconst citations: Citation[] = sources.map((source) => ({\n\t\t\tkey: generateCitationKey(source),\n\t\t\tformatted: createAPACitation(source),\n\t\t\turl: source.url,\n\t\t}));\n\n\t\t// Create response\n\t\tconst responseData: GenerationResponse = {\n\t\t\tcontent,\n\t\t\tsources,\n\t\t\tcitations,\n\t\t};\n\n\t\treturn new Response(JSON.stringify(responseData), {\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/json\",\n\t\t\t},\n\t\t});\n\t} catch (error: unknown) {\n\t\tconsole.error(\"AI Generation error:\", error);\n\n\t\t// Log more details about the error\n\t\tif (error instanceof Error) {\n\t\t\tconsole.error(\"Error name:\", error.name);\n\t\t\tconsole.error(\"Error message:\", error.message);\n\t\t\tconsole.error(\"Error stack:\", error.stack);\n\t\t}\n\n\t\tconst errorMessage =\n\t\t\terror instanceof Error ? error.message : \"Unknown error\";\n\t\treturn new Response(\n\t\t\tJSON.stringify({\n\t\t\t\terror: \"Failed to generate content\",\n\t\t\t\tdetails: errorMessage,\n\t\t\t}),\n\t\t\t{\n\t\t\t\tstatus: 500,\n\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t},\n\t\t);\n\t}\n}\n"],"names":[],"mappings":"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"}}]
}